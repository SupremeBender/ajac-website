<!DOCTYPE html>
<html>
<head>
    <title>BLUFOR Flight Plan Filing</title>
    <style>
        html, body { 
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            min-height: 100%;
            font-family: 'Segoe UI', Arial, sans-serif; 
            background-color: #1a3a66; /* Darker blue theme */
            color: #e0e0e0;
        }
        
        body {
            padding: 20px;
            line-height: 1.6;
            overflow: visible;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto;
            display: grid;
            grid-template-columns: minmax(350px, 400px) 1fr;
            gap: 20px;
            overflow: visible;
        }
        
        /* Hide all scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }
        
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .mission-form, .flight-form { 
            background: #363636; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #b8b8b8;
        }
        h1, h2, h3, h4, h5 {
            color: #5d9cec; /* Brighter blue for headings */
            margin-top: 0.5em;
            margin-bottom: 0.7em;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #2c2c2c;
            color: #e0e0e0;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #5c9ce6;
            box-shadow: 0 0 0 2px rgba(92, 156, 230, 0.2);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        select optgroup {
            font-weight: bold;
            color: #999;
            padding: 4px 0;
        }
        select option {
            padding: 6px 8px;
            font-weight: normal;
        }
        select option[value=""] {
            color: #888;
        }
        .btn { 
            background: #5d9cec; /* Blue button */
            color: white; 
            border: none; 
            padding: 10px 20px; 
            cursor: pointer;
            border-radius: 4px;
            width: auto;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .btn:hover {
            background: #4a87d8;
        }
        .mission-list {
            background: #363636;
            padding: 20px;
            border-radius: 10px;
            grid-column: 2;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 1px solid #444;
            overflow: visible;
        }
        .output-field {
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        .left-column {
            grid-column: 1;
            overflow: visible;
        }
        .flight-summary {
            background: #404040;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border: 1px solid #555;
        }
        .flight-details {
            margin: 15px 0;
            line-height: 1.5;
        }
        .flight-members {
            list-style: none;
            padding: 0;
        }
        .flight-members li {
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            background: #404040;
            border-left: 3px solid #5c9ce6;
        }
        .flight-members .member-row {
            display: flex;
            margin-bottom: 3px;
            align-items: center;
        }
        .flight-members .member-label {
            width: 100px;
            color: #b8b8b8;
            font-weight: bold;
        }
        .flight-members .member-value {
            flex: 1;
        }
        .flight-members .cross-base-warning {
            color: #ffcc00;
            font-weight: bold;
        }
        .flight-members .member-callsign {
            font-weight: bold;
        }
        .flight-members .member-aircraft,
        .flight-members .member-iff {
            font-family: 'Courier New', monospace;
        }
        .route-preview {
            font-family: 'Courier New', monospace;
            background-color: #002800;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            white-space: pre-line;
            font-size: 1.1em;
            letter-spacing: 0.5px;
            text-shadow: 0 0 2px #00ff00;
            line-height: 1.5;
            border: 1px solid #004d00;
        }
        .success-message {
            background-color: #1e4620;
            color: #a3cfbb;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #265c29;
            border-radius: 4px;
            font-weight: bold;
        }
        .mission-item {
            background: #404040;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #555;
            transition: transform 0.2s ease;
        }
        .mission-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .mission-details {
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }
        .flight-group {
            background: #323232;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            position: relative;
            border-left: 4px solid #5c9ce6;
        }
        .flight-group h4 {
            margin: 0 0 15px 0;
            color: #5c9ce6;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-left: 25px; /* Make room for the toggle icon on the left */
        }
        .flight-group h4::before {
            content: '✈️';
            margin-right: 8px;
            font-size: 1.1em;
        }
        .flight-group.collapsed .flight-content {
            display: none;
        }
        .flight-group h4::after {
            content: '▼';
            position: absolute;
            left: 5px; /* Position on the left instead of right */
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
            font-size: 0.8em;
        }
        .flight-group.collapsed h4::after {
            transform: translateY(-50%) rotate(-90deg);
        }
        .flight-group h4:hover {
            opacity: 0.9;
        }
        .flight-content {
            transition: max-height 0.3s ease-out;
        }
        .flight-group p {
            margin: 8px 0;
            display: flex;
            align-items: flex-start;
        }
        .flight-group p strong {
            margin-right: 10px;
            min-width: 100px;
            display: inline-block;
        }
        .flight-group p {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        .join-flight-inline {
            background: #2a3b52;
            border: 1px solid #3e5577;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }
        .join-flight-inline h5 {
            color: #5c9ce6;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .mission-summary {
            background: #2a3547;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #3a4557;
        }
        .mission-summary h4 {
            margin: 0 0 10px 0;
            padding-left: 25px;
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .mission-summary h4::after {
            content: '▼';
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
            font-size: 0.8em;
        }
        .mission-summary.collapsed h4::after {
            transform: translateY(-50%) rotate(-90deg);
        }
        .mission-summary.collapsed .summary-content {
            display: none;
        }
        .summary-content {
            margin-top: 10px;
        }
        .summary-flight {
            padding: 8px 10px;
            margin: 5px 0;
            background: #323745;
            border-radius: 4px;
            border-left: 3px solid #5c9ce6;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .summary-flight:hover {
            background: #3a4154;
        }
        .summary-flight .flight-callsign {
            font-weight: bold;
            width: 120px;
        }
        .summary-flight .flight-aircraft {
            width: 180px;
        }
        .summary-flight .flight-intentions {
            flex: 1;
            color: #b8b8b8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .join-flight-inline {
            background: #2a3b52;
            border: 1px solid #3e5577;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-column">
            <h1>BLUFOR Mission Planning</h1>
            
            {% if success_message %}
            <div class="success-message">
                {{ success_message }}
            </div>
            {% endif %}
            
            <div class="flight-form">
                <h2>Flight Planning</h2>
                <form id="flightPlanForm" method="POST" action="{{ url_for('flight_plan') }}">
                    <div class="form-group">
                        <label for="mission_id">Select Mission</label>
                        <select id="mission_id" name="mission_id" required>
                            <option value="">Choose a mission</option>
                            {% for mission in missions %}
                                <option value="{{ mission.id }}" {% if mission.id == selected_mission_id %}selected{% endif %}>
                                    {{ mission.name }} ({{ mission.date }}) - {{ mission.status }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if not selected_flight %}
                    <div class="new-flight-form">
                        <h3>Create New Flight</h3>
                        <div class="form-group">
                            <label for="pilot_name">Pilot Name</label>
                            <input type="text" id="pilot_name" name="pilot_name" placeholder="Enter your name" required>
                        </div>

                        <div class="form-group">
                            <label for="squadron">Select Squadron</label>
                            <select id="squadron" name="squadron" required>
                                <option value="">Choose your squadron</option>
                                {% for sqn in squadrons %}
                                    <option value="{{ sqn }}" {% if sqn == selected_squadron %}selected{% endif %}>{{ sqn }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="dep_base">Departure Base</label>
                            <select id="dep_base" name="dep_base" required>
                                <option value="">Select departure base</option>
                                {% for base in available_bases %}
                                    <option value="{{ base }}" {% if base == selected_base %}selected{% endif %}>{{ base }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="aircraft">Aircraft</label>
                            <select id="aircraft" name="aircraft" required>
                                <option value="">Select your aircraft</option>
                                {% for tail in selected_aircraft %}
                                    <option value="{{ tail }}" {% if tail == selected_aircraft_tail %}selected{% endif %}>{{ tail }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="dep_type">Departure Type</label>
                            <select id="dep_type" name="dep_type" required>
                                <option value="">Select Type</option>
                                <option value="VFR" {% if selected_dep_type == "VFR" %}selected{% endif %}>VFR</option>
                                <option value="IFR" {% if selected_dep_type == "IFR" %}selected{% endif %}>IFR</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="dep_proc">Departure Procedure</label>
                            <select id="dep_proc" name="dep_proc" required>
                                <option value="">Select Procedure</option>
                                {% for proc in dep_procs %}
                                    <option value="{{ proc }}" {% if proc == selected_dep_proc %}selected{% endif %}>{{ proc }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="training_area">Training Area</label>
                            <select id="training_area" name="training_area" required>
                                <option value="">Select Training Area</option>
                                {% for area_name in area_list %}
                                    <option value="{{ area_name }}" {% if area_name == selected_area %}selected{% endif %}>{{ area_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="intentions">Intentions</label>
                            <textarea id="intentions" name="intentions" placeholder="Describe your flight intentions" rows="3">{{ selected_intentions }}</textarea>
                        </div>

                        <div class="form-group">
                            <label for="rec_base">Recovery Base</label>
                            <select id="rec_base" name="rec_base" required>
                                <option value="">Select Recovery Base</option>
                                {% for base in base_info.keys() %}
                                    <option value="{{ base }}" {% if base == selected_rec_base %}selected{% endif %}>{{ base }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="rec_type">Recovery Type</label>
                            <select id="rec_type" name="rec_type" required>
                                <option value="">Select Type</option>
                                <option value="VFR" {% if selected_rec_type == "VFR" %}selected{% endif %}>VFR</option>
                                <option value="IFR" {% if selected_rec_type == "IFR" %}selected{% endif %}>IFR</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="rec_proc">Recovery Procedure</label>
                            <select id="rec_proc" name="rec_proc" required>
                                <option value="">Select Procedure</option>
                                {% for proc in rec_procs %}
                                    <option value="{{ proc }}" {% if proc == selected_rec_proc %}selected{% endif %}>{{ proc }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="submit" name="action" value="Preview Route" class="btn">Preview Route</button>
                            <button type="submit" name="action" value="File Flight Plan" class="btn">File Flight Plan</button>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Route Preview Output -->
                    <div class="output-field {% if not output %}hidden{% endif %}" id="outputField">
                        {{ output|safe if output else '' }}
                    </div>
                </form>
            </div>
            
            <!-- Mission Creation Form -->
            <div class="mission-form">
                <h2>Create New Mission</h2>
                <form id="missionForm">
                    <div class="form-group">
                        <label for="mission_name">Mission Name</label>
                        <input type="text" id="mission_name" name="mission_name" placeholder="Enter mission name" required>
                    </div>
                    <div class="form-group">
                        <label for="mission_date">Mission Date</label>
                        <input type="date" id="mission_date" name="mission_date" required>
                    </div>
                    <h3>Active Runways</h3>
                    {% for base, data in base_info.items() %}
                    <div class="form-group">
                        <label for="rwy_{{ base }}">{{ data.name }} ({{ base }})</label>
                        <select id="rwy_{{ base }}" name="rwy_{{ base }}" required>
                            {% for rwy in data.runways %}
                            <option value="{{ rwy }}" {% if rwy == data.runway_in_use %}selected{% endif %}>RWY {{ rwy }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endfor %}
                    <button type="submit" class="btn">Create Mission</button>
                </form>
            </div>

        </div>

        <div class="mission-list">
            <h2>Active Missions</h2>
            <div id="missionsList"></div>
        </div>
    </div>

    <script>
        // Clean event handlers that update form elements based on configuration files
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[INFO] Initializing form handlers with proper JSON configuration');
            
            // Load active missions
            loadActiveMissions();
            
            // Handle form submission for joining flights
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form.querySelector('input[name="action"][value="Join Flight"]')) {
                    e.preventDefault();
                    console.log('[JOIN] Handling join flight form submission');
                    
                    const formData = new FormData(form);
                    
                    for (let [key, value] of formData.entries()) {
                        console.log(`[JOIN] ${key}: ${value}`);
                    }
                    
                    const missionId = formData.get('mission_id');
                    const callsignPrefix = formData.get('callsign_prefix');
                    const desiredSlot = formData.get('desired_slot');
                    const pilotName = formData.get('pilot_name');
                    const aircraft = formData.get('aircraft');
                    
                    if (!missionId || missionId === "0" || !callsignPrefix || !desiredSlot || !aircraft) {
                        alert('Missing required fields for joining flight');
                        console.error(`[JOIN ERROR] Invalid form data: mission_id=${missionId}, callsign=${callsignPrefix}, slot=${desiredSlot}, aircraft=${aircraft}`);
                        return;
                    }
                    
                    console.log(`[JOIN] Sending join request for mission=${missionId}, callsign=${callsignPrefix}, slot=${desiredSlot}, aircraft=${aircraft}`);
                    
                    fetch(window.location.pathname, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'text/html'
                        }
                    })
                    .then(response => {
                        console.log('[JOIN] Response status:', response.status);
                        
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Server returned ${response.status}: ${text}`);
                            });
                        }
                        
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('[JOIN] Error joining flight:', error);
                        alert('Error joining flight: ' + error);
                    });
                }
            });

            // Handle squadron selection - properly fetch bases from server
            const squadronSelect = document.getElementById('squadron');
            if (squadronSelect) {
                squadronSelect.addEventListener('change', function() {
                    const squadronValue = this.value;
                    console.log('[INFO] Squadron selected:', squadronValue);
                    
                    // Clear dependent fields
                    const depBaseSelect = document.getElementById('dep_base');
                    const aircraftSelect = document.getElementById('aircraft');
                    
                    if (depBaseSelect) depBaseSelect.innerHTML = '<option value="">Select departure base</option>';
                    if (aircraftSelect) aircraftSelect.innerHTML = '<option value="">Select aircraft</option>';
                    
                    if (!squadronValue) return;
                    
                    // Fetch bases for this squadron from the server
                    fetch('/squadron-bases', {
                        method: 'POST',
                        body: new FormData(document.getElementById('flightPlanForm')),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (depBaseSelect && data.html) {
                            depBaseSelect.innerHTML = data.html;
                            console.log('[INFO] Updated departure bases for squadron', squadronValue);
                        }
                    })
                    .catch(error => {
                        console.error('[ERROR] Failed to fetch bases for squadron:', error);
                    });
                });
            }
            
            // Handle departure base selection
            const depBaseSelect = document.getElementById('dep_base');
            if (depBaseSelect) {
                depBaseSelect.addEventListener('change', function() {
                    const baseValue = this.value;
                    const squadronValue = squadronSelect ? squadronSelect.value : '';
                    console.log('[INFO] Departure base selected:', baseValue);
                    
                    // Clear dependent fields
                    const aircraftSelect = document.getElementById('aircraft');
                    const depTypeSelect = document.getElementById('dep_type');
                    
                    if (aircraftSelect) aircraftSelect.innerHTML = '<option value="">Select aircraft</option>';
                    if (depTypeSelect) {
                        depTypeSelect.innerHTML = `
                            <option value="">Select type</option>
                            <option value="VFR">VFR</option>
                            <option value="IFR">IFR</option>
                        `;
                    }
                    
                    if (!squadronValue || !baseValue) return;
                    
                    // Fetch aircraft for this squadron and base from the server
                    const formData = new FormData();
                    formData.append('squadron', squadronValue);
                    formData.append('base', baseValue);
                    formData.append('mission_id', document.getElementById('mission_id')?.value || '');
                    
                    fetch('/squadron-aircraft', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (aircraftSelect && data.html) {
                            aircraftSelect.innerHTML = data.html;
                            console.log('[INFO] Updated aircraft for squadron', squadronValue, 'at base', baseValue);
                        }
                    })
                    .catch(error => {
                        console.error('[ERROR] Failed to fetch aircraft:', error);
                    });
                });
            }
            
            // Handle departure type selection
            const depTypeSelect = document.getElementById('dep_type');
            if (depTypeSelect) {
                depTypeSelect.addEventListener('change', function() {
                    updateProcedures('dep');
                });
            }
            
            // Handle recovery base selection
            const recBaseSelect = document.getElementById('rec_base');
            if (recBaseSelect) {
                recBaseSelect.addEventListener('change', function() {
                    const recTypeSelect = document.getElementById('rec_type');
                    if (recTypeSelect) {
                        recTypeSelect.innerHTML = `
                            <option value="">Select type</option>
                            <option value="VFR">VFR</option>
                            <option value="IFR">IFR</option>
                        `;
                    }
                });
            }
            
            // Handle recovery type selection
            const recTypeSelect = document.getElementById('rec_type');
            if (recTypeSelect) {
                recTypeSelect.addEventListener('change', function() {
                    updateProcedures('rec');
                });
            }
            
            // Function to update procedures based on type selection
            function updateProcedures(procType) {
                const baseSelectId = procType === 'dep' ? 'dep_base' : 'rec_base';
                const typeSelectId = procType === 'dep' ? 'dep_type' : 'rec_type';
                const procSelectId = procType === 'dep' ? 'dep_proc' : 'rec_proc';
                
                const baseSelect = document.getElementById(baseSelectId);
                const typeSelect = document.getElementById(typeSelectId);
                const procSelect = document.getElementById(procSelectId);
                
                const baseValue = baseSelect ? baseSelect.value : '';
                const typeValue = typeSelect ? typeSelect.value : '';
                
                if (!baseValue || !typeValue || !procSelect) return;
                
                // Clear the procedures dropdown
                procSelect.innerHTML = '<option value="">Select procedure</option>';
                
                // Prepare form data
                const formData = new FormData();
                formData.append('base', baseValue);
                formData.append('type', typeValue);
                formData.append('proc_type', procType);
                
                // Get active runway from the mission
                const missionId = document.getElementById('mission_id')?.value;
                if (missionId) {
                    formData.append('mission_id', missionId);
                }
                
                // Fetch procedures from the server
                fetch('/get-procedures', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.html) {
                        procSelect.innerHTML = data.html;
                        console.log(`[INFO] Updated ${procType} procedures for base ${baseValue}, type ${typeValue}`);
                    }
                })
                .catch(error => {
                    console.error(`[ERROR] Failed to fetch ${procType} procedures:`, error);
                });
            }

            // Function to load active missions from the server
            function loadActiveMissions() {
                console.log('[INFO] Loading active missions');
                fetch('/missions')
                    .then(response => response.json())
                    .then(missions => {
                        console.log('[INFO] Missions loaded successfully:', Object.keys(missions).length);
                        displayMissions(missions);
                    })
                    .catch(error => {
                        console.error('[ERROR] Error loading missions:', error);
                        const missionsList = document.getElementById('missionsList');
                        if (missionsList) {
                            missionsList.innerHTML = `<div class="error-message">
                                <p>Error loading missions: ${error.message}</p>
                            </div>`;
                        }
                    });
            }

            // Function to display missions in the Active Missions panel
            function displayMissions(missions) {
                // This function stays mostly the same but with improved error handling
                const missionsList = document.getElementById('missionsList');
                if (!missionsList) return;
                
                // Clear existing content
                missionsList.innerHTML = '';
                
                if (Object.keys(missions).length === 0) {
                    missionsList.innerHTML = '<p>No active missions found.</p>';
                    return;
                }
                
                // Loop through each mission
                for (const missionId in missions) {
                    const mission = missions[missionId];
                    
                    // Create mission container
                    const missionDiv = document.createElement('div');
                    missionDiv.className = 'mission-item';
                    
                    // Mission header
                    const missionHeader = document.createElement('h3');
                    missionHeader.textContent = mission.name;
                    missionDiv.appendChild(missionHeader);
                    
                    // Mission details
                    const missionDetails = document.createElement('div');
                    missionDetails.className = 'mission-details';
                    missionDetails.innerHTML = `
                        <p><strong>Date:</strong> ${mission.date}</p>
                        <p><strong>Status:</strong> ${mission.status}</p>
                    `;
                    missionDiv.appendChild(missionDetails);
                    
                    // Check if mission has flights
                    if (mission.flights && mission.flights.length > 0) {
                        // Create mission summary section
                        const missionSummary = document.createElement('div');
                        missionSummary.className = 'mission-summary';
                        
                        const summaryHeader = document.createElement('h4');
                        summaryHeader.textContent = 'Flight Summary';
                        summaryHeader.addEventListener('click', function() {
                            missionSummary.classList.toggle('collapsed');
                        });
                        missionSummary.appendChild(summaryHeader);
                        
                        const summaryContent = document.createElement('div');
                        summaryContent.className = 'summary-content';
                        
                        // Count aircraft by type for each flight
                        mission.flights.forEach(flight => {
                            const flightItem = document.createElement('div');
                            flightItem.className = 'summary-flight';
                            
                            // Count number of each aircraft type in the flight
                            const memberCount = Object.keys(flight.members).length;
                            
                            // Create flight summary with callsign, aircraft type count and intentions
                            flightItem.innerHTML = `
                                <span class="flight-callsign">${flight.callsign}</span>
                                <span class="flight-aircraft">${memberCount}× ${flight.aircraft_type}</span>
                                <span class="flight-intentions">${flight.intentions || 'No intentions specified'}</span>
                            `;
                            
                            // When clicking on a summary flight, scroll to and expand the corresponding flight
                            flightItem.addEventListener('click', function() {
                                // Find the corresponding flight group
                                const flightGroups = missionDiv.querySelectorAll('.flight-group');
                                for (const group of flightGroups) {
                                    if (group.querySelector('h4').textContent.includes(flight.callsign)) {
                                        // Expand the flight if collapsed
                                        if (group.classList.contains('collapsed')) {
                                            group.classList.remove('collapsed');
                                        }
                                        // Scroll to the flight
                                        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        break;
                                    }
                                }
                            });
                            
                            summaryContent.appendChild(flightItem);
                        });
                        
                        missionSummary.appendChild(summaryContent);
                        missionDiv.appendChild(missionSummary);
                        
                        // Process each flight
                        for (const flight of mission.flights) {
                            // Create flight group container
                            const flightGroup = document.createElement('div');
                            flightGroup.className = 'flight-group collapsed';
                            
                            // Flight group header with callsign and aircraft type
                            const flightHeader = document.createElement('h4');
                            flightHeader.textContent = `${flight.callsign} Flight (${flight.aircraft_type})`;
                            
                            // Make the header clickable for collapsing/expanding
                            flightHeader.addEventListener('click', function() {
                                flightGroup.classList.toggle('collapsed');
                            });
                            
                            flightGroup.appendChild(flightHeader);
                            
                            // Create a container for all flight content
                            const flightContent = document.createElement('div');
                            flightContent.className = 'flight-content';
                            
                            // Flight details
                            const flightDetails = document.createElement('div');
                            
                            // Highlight the departure and arrival bases in the route
                            let routeDisplay = '';
                            if (flight.route) {
                                const routeParts = flight.route.split(' ');
                                if (routeParts.length >= 2) {
                                    // The first part is the departure base
                                    const depBase = routeParts[0];
                                    // The last part is the arrival base
                                    const arrBase = routeParts[routeParts.length - 1];
                                    
                                    // Create a new array with highlighted first and last elements
                                    const highlightedRoute = routeParts.map((part, index) => {
                                        if (index === 0) {
                                            return `<span style="color: #5d9cec; font-weight: bold;">${part}</span>`;
                                        } else if (index === routeParts.length - 1) {
                                            return `<span style="color: #5d9cec; font-weight: bold;">${part}</span>`;
                                        } else {
                                            return part;
                                        }
                                    });
                                    
                                    routeDisplay = highlightedRoute.join(' ');
                                } else {
                                    routeDisplay = flight.route;
                                }
                            } else {
                                routeDisplay = 'Not specified';
                            }
                            
                            flightDetails.innerHTML = `
                                <p><strong>Squadron:</strong> ${flight.squadron}</p>
                                <p><strong>Aircraft:</strong> ${flight.aircraft_type}</p>
                                <p><strong>Area:</strong> ${flight.area || 'Not specified'}</p>
                                ${flight.intentions ? `<p><strong>Intentions:</strong> ${flight.intentions}</p>` : ''}
                                <p><strong>Route:</strong> <span style="font-family: 'Courier New', monospace;">${routeDisplay}</span></p>
                                <p><strong>TACAN:</strong> ${flight.tacan || 'N/A'}</p>
                                <p><strong>Frequency:</strong> ${flight.frequency || 'N/A'}</p>
                            `;
                            flightContent.appendChild(flightDetails);
                            
                            // Flight members list
                            const membersHeader = document.createElement('h5');
                            membersHeader.textContent = 'Flight Members:';
                            flightContent.appendChild(membersHeader);
                            
                            const membersList = document.createElement('ul');
                            membersList.className = 'flight-members';
                            
                            // Display all members
                            const members = flight.members || {};
                            const memberNames = Object.keys(members);
                            
                            if (memberNames.length > 0) {
                                // Sort members by callsign order
                                const sortedMembers = memberNames.sort((a, b) => {
                                    // Extract the position number (last digit of callsign)
                                    const posA = parseInt(members[a].callsign.slice(-1));
                                    const posB = parseInt(members[b].callsign.slice(-1));
                                    return posA - posB;
                                });
                                
                                for (const memberName of sortedMembers) {
                                    const member = members[memberName];
                                    const memberItem = document.createElement('li');
                                    
                                    // Build member details with rows for each piece of information
                                    let memberHTML = '';
                                    
                                    // Row 1: Callsign
                                    memberHTML += `<div class="member-row">
                                        <span class="member-label">Callsign:</span>
                                        <span class="member-value member-callsign">${member.callsign}</span>
                                    </div>`;
                                    
                                    // Row 2: Aircraft
                                    memberHTML += `<div class="member-row">
                                        <span class="member-label">Aircraft:</span>
                                        <span class="member-value member-aircraft">
                                        ${member.aircraft}
                                        ${member.is_cross_base ? ` <span class="cross-base-warning">parked at ${member.base}</span>` : ''}
                                        </span>
                                    </div>`;
                                    
                                    // Row 3: IFF code
                                    memberHTML += `<div class="member-row">
                                        <span class="member-label">IFF:</span>
                                        <span class="member-value member-iff">${member.IFF}</span>
                                    </div>`;
                                    
                                    // Row 4: Pilot name
                                    memberHTML += `<div class="member-row">
                                        <span class="member-label">Pilot:</span>
                                        <span class="member-value">${memberName}</span>
                                    </div>`;
                                    
                                    memberItem.innerHTML = memberHTML;
                                    membersList.appendChild(memberItem);
                                }
                            } else {
                                const noMembersItem = document.createElement('li');
                                noMembersItem.textContent = 'No members assigned yet';
                                membersList.appendChild(noMembersItem);
                            }
                            
                            flightContent.appendChild(membersList);
                            
                            // Add "Join as Wingman" buttons for specific positions if flight isn't full
                            if (Object.keys(members).length < 4 && mission.status !== 'LOCKED') {
                                const joinSection = document.createElement('div');
                                joinSection.className = 'join-flight-inline';
                                joinSection.innerHTML = '<h5>Join this flight:</h5>';
                                
                                // Create buttons for available positions
                                const takenPositions = [];
                                for (const memberName in members) {
                                    const callsign = members[memberName].callsign;
                                    // Extract the position number (last digit of callsign)
                                    const posNumber = callsign.slice(-1);
                                    takenPositions.push(posNumber);
                                }
                                
                                // Create buttons for available positions
                                for (let pos = 2; pos <= 4; pos++) {
                                    if (!takenPositions.includes(pos.toString())) {
                                        const joinButton = document.createElement('button');
                                        joinButton.className = 'btn';
                                        joinButton.style.marginRight = '10px';
                                        joinButton.style.marginBottom = '10px';
                                        
                                        // Extract callsign parts for button display
                                        const callsignParts = flight.callsign.split(' ');
                                        const callsignPrefix = callsignParts[0]; // e.g., "LION"
                                        const flightNumber = callsignParts[1]; // e.g., "0"
                                        
                                        joinButton.textContent = `Join as ${callsignPrefix}${flightNumber}${pos}`;
                                        
                                        // Add click handler
                                        joinButton.addEventListener('click', function() {
                                            // Show join form for this specific position
                                            const joinFormContainer = document.createElement('div');
                                            joinFormContainer.id = `join-form-${flight.callsign}-${pos}`;
                                            joinFormContainer.className = 'join-form-container';
                                            joinFormContainer.style.marginTop = '15px';
                                            
                                            const joinForm = document.createElement('form');
                                            joinForm.action = window.location.pathname;
                                            joinForm.method = 'POST';
                                            
                                            // Add hidden fields for mission_id, callsign_prefix, and slot
                                            const hiddenFields = [
                                                {name: 'mission_id', value: mission.id || missionId},
                                                {name: 'callsign_prefix', value: flight.callsign},
                                                {name: 'desired_slot', value: pos},
                                                {name: 'action', value: 'Join Flight'}
                                            ];
                                            
                                            hiddenFields.forEach(field => {
                                                const input = document.createElement('input');
                                                input.type = 'hidden';
                                                input.name = field.name;
                                                input.value = field.value;
                                                joinForm.appendChild(input);
                                            });
                                            
                                            // Pilot name field with validation
                                            const pilotField = document.createElement('div');
                                            pilotField.className = 'form-group';
                                            pilotField.innerHTML = `
                                                <label for="pilot_name_${flight.callsign}_${pos}">Your Name:</label>
                                                <input type="text" id="pilot_name_${flight.callsign}_${pos}" 
                                                       name="pilot_name" required pattern="[A-Za-z0-9_-]+"
                                                       title="Use only letters, numbers, underscore or hyphen"
                                                       placeholder="Enter your pilot name">
                                            `;
                                            joinForm.appendChild(pilotField);
                                            
                                            // Aircraft selection field
                                            const aircraftField = document.createElement('div');
                                            aircraftField.className = 'form-group';
                                            aircraftField.innerHTML = `
                                                <label for="aircraft_${flight.callsign}_${pos}">Select Aircraft:</label>
                                                <select id="aircraft_${flight.callsign}_${pos}" name="aircraft" required>
                                                    <option value="">Loading aircraft...</option>
                                                </select>
                                            `;
                                            joinForm.appendChild(aircraftField);
                                            
                                            // Add confirm button
                                            const confirmBtn = document.createElement('button');
                                            confirmBtn.type = 'submit';
                                            confirmBtn.className = 'btn';
                                            confirmBtn.textContent = 'Confirm Join';
                                            joinForm.appendChild(confirmBtn);
                                            
                                            // Cancel button
                                            const cancelBtn = document.createElement('button');
                                            cancelBtn.className = 'btn';
                                            cancelBtn.style.marginLeft = '10px';
                                            cancelBtn.style.backgroundColor = '#dc3545';
                                            cancelBtn.textContent = 'Cancel';
                                            cancelBtn.addEventListener('click', function(e) {
                                                e.preventDefault();
                                                joinFormContainer.remove();
                                            });
                                            joinForm.appendChild(cancelBtn);
                                            
                                            joinFormContainer.appendChild(joinForm);
                                            this.parentNode.appendChild(joinFormContainer);
                                            
                                            this.parentNode.querySelectorAll('button').forEach(btn => {
                                                if (btn !== cancelBtn && btn !== confirmBtn) {
                                                    btn.style.display = 'none';
                                                }
                                            });
                                            
                                            // Fetch compatible aircraft
                                            const formData = new FormData();
                                            formData.append('mission_id', mission.id || missionId);
                                            formData.append('squadron', flight.squadron);
                                            formData.append('base', flight.departure.base);
                                            formData.append('aircraft_type', flight.aircraft_type);
                                            formData.append('callsign_prefix', flight.callsign);
                                            
                                            fetch('/squadron-aircraft', {
                                                method: 'POST',
                                                body: formData
                                            })
                                            .then(response => response.json())
                                            .then(data => {
                                                const aircraftSelect = document.getElementById(`aircraft_${flight.callsign}_${pos}`);
                                                if (aircraftSelect && data.html) {
                                                    aircraftSelect.innerHTML = data.html;
                                                }
                                            })
                                            .catch(error => {
                                                console.error('[ERROR] Error loading aircraft:', error);
                                                const aircraftSelect = document.getElementById(`aircraft_${flight.callsign}_${pos}`);
                                                if (aircraftSelect) {
                                                    aircraftSelect.innerHTML = '<option value="">Error loading aircraft</option>';
                                                }
                                            });
                                        });
                                        
                                        joinSection.appendChild(joinButton);
                                    }
                                }
                                
                                flightContent.appendChild(joinSection);
                            }
                            
                            flightGroup.appendChild(flightContent);
                            missionDiv.appendChild(flightGroup);
                        }
                    } else {
                        const noFlights = document.createElement('p');
                        noFlights.textContent = 'No flights created for this mission yet.';
                        missionDiv.appendChild(noFlights);
                    }
                    
                    missionsList.appendChild(missionDiv);
                }
            }

            // Handle flight plan form for route preview
            const flightPlanForm = document.getElementById('flightPlanForm');
            if (flightPlanForm) {
                flightPlanForm.addEventListener('submit', function(e) {
                    // Check which action button was clicked
                    const submitter = e.submitter;
                    
                    if (submitter && submitter.value === 'Preview Route') {
                        e.preventDefault();

                        // Save current form values before submission
                        const currentValues = {
                            squadron: document.getElementById('squadron')?.value,
                            dep_base: document.getElementById('dep_base')?.value,
                            aircraft: document.getElementById('aircraft')?.value,
                            dep_type: document.getElementById('dep_type')?.value,
                            dep_proc: document.getElementById('dep_proc')?.value,
                            training_area: document.getElementById('training_area')?.value,
                            rec_base: document.getElementById('rec_base')?.value,
                            rec_type: document.getElementById('rec_type')?.value,
                            rec_proc: document.getElementById('rec_proc')?.value
                        };
                        
                        // Create form data with action
                        const formData = new FormData(this);
                        formData.append('action', 'Preview Route');
                        
                        // Send form data via fetch
                        fetch('/', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.text())
                        .then(html => {
                            // Parse the HTML response to extract just the route preview
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const previewElement = doc.querySelector('.route-preview');
                            
                            if (previewElement) {
                                // Update just the output field
                                const outputField = document.getElementById('outputField');
                                if (outputField) {
                                    outputField.innerHTML = previewElement.outerHTML;
                                    outputField.classList.remove('hidden');
                                }
                                
                                // Restore all saved values
                                if (document.getElementById('squadron')) 
                                    document.getElementById('squadron').value = currentValues.squadron;
                                if (document.getElementById('dep_base'))
                                    document.getElementById('dep_base').value = currentValues.dep_base;
                                if (document.getElementById('aircraft'))
                                    document.getElementById('aircraft').value = currentValues.aircraft;
                                if (document.getElementById('dep_type'))
                                    document.getElementById('dep_type').value = currentValues.dep_type;
                                if (document.getElementById('dep_proc'))
                                    document.getElementById('dep_proc').value = currentValues.dep_proc;
                                if (document.getElementById('training_area'))
                                    document.getElementById('training_area').value = currentValues.training_area;
                                if (document.getElementById('rec_base'))
                                    document.getElementById('rec_base').value = currentValues.rec_base;
                                if (document.getElementById('rec_type'))
                                    document.getElementById('rec_type').value = currentValues.rec_type;
                                if (document.getElementById('rec_proc'))
                                    document.getElementById('rec_proc').value = currentValues.rec_proc;
                                
                                console.log('[INFO] Form values restored after preview');
                            } else {
                                console.error('[ERROR] Could not find route preview in response');
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Error submitting form:', error);
                        });
                    }
                });
            }

            // Handle mission creation form
            const missionForm = document.getElementById('missionForm');
            if (missionForm) {
                missionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    
                    fetch('/create_mission', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();
                        } else {
                            alert('Error creating mission: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('[ERROR] Error creating mission:', error);
                        alert('Error creating mission: ' + error);
                    });
                });
            }
        });

        // Add this function for validating the flight plan form fields
        function validateFlightPlanForm() {
            const requiredFields = ['squadron', 'dep_base', 'aircraft', 'dep_type', 'dep_proc', 
                                   'training_area', 'rec_base', 'rec_type', 'rec_proc'];
            const fieldLabels = {
                'squadron': 'Squadron', 
                'dep_base': 'Departure Base', 
                'aircraft': 'Aircraft', 
                'dep_type': 'Departure Type',
                'dep_proc': 'Departure Procedure', 
                'training_area': 'Training Area', 
                'rec_base': 'Recovery Base',
                'rec_type': 'Recovery Type', 
                'rec_proc': 'Recovery Procedure'
            };
            
            let missing = [];
            
            // Check each required field
            for (const field of requiredFields) {
                const element = document.getElementById(field);
                if (!element || !element.value) {
                    missing.push(fieldLabels[field]);
                }
            }
            
            // If any fields are missing, show an error
            if (missing.length > 0) {
                alert(`Please fill in all required fields: ${missing.join(', ')}`);
                return false;
            }
            
            // All fields are present
            console.log('[INFO] Flight plan form validation passed');
            return true;
        }
    </script>
</body>
</html>
