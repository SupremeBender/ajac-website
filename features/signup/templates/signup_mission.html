{% extends "base.html" %}
{% block title %}{{ mission.name }} - Signup{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/signup_mission.css') }}">
{% endblock %}

{% block content %}
<div id="signup-root" data-campaign-id="{{ campaign_id }}" data-persistent-ac-location="{{ persistent_ac_location|default(false, true) }}"></div>
<pre id="debug-aircraft-data-json" style="display:none;">{{ aircraft_data | tojson }}</pre>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Mission Signup</h1>
        <a href="{{ url_for('signup.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i> Back to Missions
        </a>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">{{ mission.name }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <p class="lead">{{ mission.description }}</p>
                    <hr>
                </div>
                <div class="col-md-4">
                    {% if not user_flight %}
                    <div class="flight-create-panel card p-3 shadow-sm">
                        <h4 class="mb-3" style="color: var(--primary-color);">Create New Flight</h4>
                        <form id="flight-create-form" method="POST" action="{{ url_for('signup.create_new_flight', mission_id=mission.id) }}">
                            <div class="form-group">
                                <label for="squadron">Squadron</label>
                                <select class="form-control" id="squadron" name="squadron" required>
                                    <option value="">Select squadron</option>
                                    {% if squadrons %}
                                        {% if squadrons is mapping %}
                                            {# Legacy format: dict with squadron_id: squadron_data #}
                                            {% for sq_id, sq in squadrons.items() %}
                                            <option value="{{ sq_id }}">{{ sq_id }} - {{ sq.get('name', sq_id) }}</option>
                                            {% endfor %}
                                        {% else %}
                                            {# New format: list of squadron objects #}
                                            {% for sq in squadrons %}
                                            <option value="{{ sq.id }}">{{ sq.id }} - {{ sq.get('name', sq.id) }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="form-group" id="depBaseGroup" style="display:none;">
                                <label for="departure_base">Departure Base</label>
                                <select class="form-control" id="departure_base" name="departure_base" required>
                                    <option value="">Select departure base</option>
                                    {% for base_id, base in bases.items() %}
                                    <option value="{{ base_id }}">{{ base.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" id="recBaseGroup" style="display:none;">
                                <label for="recovery_base">Recovery Base</label>
                                <select class="form-control" id="recovery_base" name="recovery_base" required>
                                    <option value="">Select recovery base</option>
                                    {% for base_id, base in bases.items() %}
                                    <option value="{{ base_id }}">{{ base.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" id="areaGroup" style="display:none;">
                                <label for="operations_area">Operations Area</label>
                                <select class="form-control" id="operations_area" name="operations_area" required>
                                    <option value="">Select area</option>
                                    {% for area_id, area in operations_areas.items() %}
                                    <option value="{{ area_id }}">{{ area.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" id="missionTypeGroup" style="display:none;">
                                <label for="mission_type">Mission Type</label>
                                <select class="form-control" id="mission_type" name="mission_type" required>
                                    <option value="">Select mission type</option>
                                    {% for mt_id, mt in mission_types.items() %}
                                    <option value="{{ mt_id }}">{{ mt_id }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group" id="remarksGroup" style="display:none;">
                                <label for="remarks">Remarks</label>
                                <input type="text" class="form-control" id="remarks" name="remarks" maxlength="100" placeholder="Optional remarks">
                            </div>
                            <div class="form-group" id="aircraftGroup" style="display:none;">
                                <label for="aircraft_id">Aircraft</label>
                                <select class="form-control" id="aircraft_id" name="aircraft_id" required>
                                    <option value="">Select aircraft</option>
                                </select>
                            </div>
                            {% if is_admin or is_mission_maker %}
                            <div class="form-group">
                                <label for="side">Team Side</label>
                                <select class="form-control" id="side" name="side" required>
                                    <option value="blue">Blue</option>
                                    <option value="red">Red</option>
                                </select>
                                <small class="form-text text-muted">Admins and mission makers can create flights for either team.</small>
                            </div>
                            {% endif %}
                            <button type="submit" class="btn btn-primary mt-2 w-100">Create Flight</button>
                        </form>
                    </div>
                    {% else %}
                    <!-- Info box for users already in a flight. Uses card styling for consistency. -->
                    <div class="card p-3 shadow-sm" style="background: var(--card-bg, #23272b); border: 1.5px solid var(--primary-color, #5d9cec); margin-bottom: 0;">
                        <h4 class="mb-2" style="color: var(--primary-color); font-weight:800; font-size:1.25em; letter-spacing:0.5px;">Your Flight</h4>
                        <div style="margin-bottom: 0.5em;"><strong>Callsign:</strong> {{ user_flight.callsign }}{{ '%02d' % (user_position|int) }}</div>
                        <div style="margin-bottom: 0.5em;"><strong>Aircraft:</strong> {% set mypilot = user_flight.pilots|selectattr('position', 'equalto', user_position|string)|list|first %}{{ mypilot.aircraft or mypilot.aircraft_id or 'N/A' }}</div>
                        <div style="margin-bottom: 0.5em;"><strong>Squawk:</strong> {{ mypilot.transponder or 'â€”' }}</div>
                        <div style="margin-bottom: 0.5em;"><strong>Squadron:</strong> {{ user_flight.squadron }}</div>
                        <form method="POST" action="{{ url_for('signup.leave_existing_flight', mission_id=mission.id, flight_id=user_flight.flight_id) }}" style="display:inline; margin-top:10px;">
                            <button type="submit" class="btn btn-danger btn-sm">Leave Flight</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Claimable Flights Section (Curated Slots) -->
    {% if mission.curated_slots and mission.curated_slots|length > 0 and not user_flight %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">Claimable Flights</h3>
        </div>
        <div class="card-body">
            <div id="curated-slots-list">
                {% for slot in mission.curated_slots %}
                <div class="flight-group mb-3 p-3" style="background:var(--card-bg); border:1.5px solid var(--primary-color, #5d9cec); border-radius:8px;">
                    <div class="d-flex flex-wrap align-items-center mb-2">
                        <div class="mr-4"><strong>Label:</strong> {{ slot.label }}</div>
                        <div class="mr-4"><strong>Role:</strong> {{ slot.role }}</div>
                        <div class="mr-4"><strong>Allowed Squadrons:</strong> {{ slot.squadrons|join(', ') }}</div>
                        <div class="mr-4"><strong>Seats:</strong> {{ slot.seats }}</div>
                        <div class="mr-4"><strong>Description:</strong> {{ slot.description }}</div>
                    </div>
                    <!-- Any user can claim curated slots (squadron restrictions removed) -->
                    {% if not user_flight %}
                    <button class="btn btn-success btn-sm" onclick="showClaimForm('{{ loop.index0 }}')">Claim this slot</button>
                    <div id="claim-form-{{ loop.index0 }}" class="mt-3" style="display:none;">
                        <form method="POST" action="{{ url_for('signup.claim_curated_slot', mission_id=mission.id, slot_idx=loop.index0) }}">
                            <input type="hidden" name="slot_idx" value="{{ loop.index0 }}">
                            
                            <!-- Squadron Selection -->
                            <div class="form-group">
                                <label for="squadron_{{ loop.index0 }}">Squadron</label>
                                <select class="form-control squadron-select" id="squadron_{{ loop.index0 }}" name="squadron" required>
                                    <option value="">Select squadron</option>
                                    {% for sq in slot.squadrons %}
                                        {% if sq in squadrons %}
                                        <option value="{{ sq }}">{{ sq }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Departure Base -->
                            <div class="form-group">
                                <label for="departure_base_{{ loop.index0 }}">Departure Base</label>
                                <select class="form-control base-select" id="departure_base_{{ loop.index0 }}" name="departure_base" required>
                                    <option value="">Select departure base</option>
                                    {% for base_id, base in bases.items() %}
                                    <option value="{{ base_id }}">{{ base.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Recovery Base -->
                            <div class="form-group">
                                <label for="recovery_base_{{ loop.index0 }}">Recovery Base</label>
                                <select class="form-control" name="recovery_base" id="recovery_base_{{ loop.index0 }}">
                                    <option value="">Select recovery base</option>
                                    {% for base_id, base in bases.items() %}
                                    <option value="{{ base_id }}">{{ base.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Operations Area -->
                            <div class="form-group">
                                <label for="operations_area_{{ loop.index0 }}">Operations Area</label>
                                <select class="form-control" name="operations_area" id="operations_area_{{ loop.index0 }}" required>
                                    <option value="">Select area</option>
                                    {% for area_id, area in operations_areas.items() %}
                                    <option value="{{ area_id }}">{{ area.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Aircraft -->
                            <div class="form-group">
                                <label for="aircraft_id_{{ loop.index0 }}">Aircraft</label>
                                <select class="form-control aircraft-select" name="aircraft_id" id="aircraft_id_{{ loop.index0 }}" required>
                                    <option value="">Select aircraft</option>
                                    <!-- Options will be populated by JavaScript based on squadron selection -->
                                </select>
                            </div>
                            
                            <!-- Remarks -->
                            <div class="form-group">
                                <label for="remarks_{{ loop.index0 }}">Remarks</label>
                                <input type="text" class="form-control" name="remarks" id="remarks_{{ loop.index0 }}" maxlength="100" placeholder="Optional remarks">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Claim and Create Flight</button>
                            <button type="button" class="btn btn-secondary" onclick="hideClaimForm('{{ loop.index0 }}')">Cancel</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Current Flights Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">Current Flights</h3>
            <button id="close-all-flights" class="btn btn-sm btn-secondary float-right" style="margin-top:-32px;">Close All</button>
        </div>
        <div class="card-body">
            {% if flights %}
            <div id="flights-list">
                {% for flight in flights %}
                {% set fid = flight.id if flight.id is defined else (flight.flight_id if flight.flight_id is defined else flight.flight_number) %}
                <div class="flight-group collapsed">
                    <div class="flight-collapsed-row" tabindex="0" role="button" aria-expanded="false" aria-controls="flight-details-{{ fid }}">
                        <span style="font-weight:bold">{{ flight.callsign }}{{ flight.flight_number }}</span>
                        <span>{{ flight.squadron }}</span>
                        <span>{{ flight.mission_type }}</span>
                        <span class="flight-collapsed-remarks" title="{{ flight.remarks }}">{{ flight.remarks or 'No remarks' }}</span>
                        <span class="flight-collapsed-members">{{ flight.pilots|length }}/4</span>
                        <span class="flight-collapsed-status {{ flight.status|default('OPEN') }}">{{ flight.status|default('OPEN') }}</span>
                        <span class="triangle" style="margin-left:auto; transition: transform 0.2s; display:inline-block; font-size:1.2em;">&#9660;</span>
                    </div>
                    <div class="flight-expanded-content" id="flight-details-{{ fid }}" style="padding: 32px 32px 18px 32px !important; display:none;">
                        <!-- Flight info block: only Departure Base, Area, Mission, Remarks -->
                        <div class="flight-info-block" style="margin-bottom: 1.2em;">
                            <div><strong>Departure Base:</strong> {{ flight.departure_base }}</div>
                            <div><strong>Area:</strong> {{ flight.operations_area }}</div>
                            <div><strong>Mission:</strong> {{ flight.mission_type }}</div>
                            {% if flight.remarks %}
                            <div style="margin-top:8px; font-style:italic; opacity:0.8;"><strong>Remarks:</strong> {{ flight.remarks }}</div>
                            {% endif %}
                        </div>
                        <!-- Pilot roster table -->
                        <div class="pilot-roster" style="padding:0;">
                            <table class="table" style="width:100%; border-collapse:collapse; margin:0; font-size:0.9em;">
                                <thead>
                                    <tr>
                                        <th style="padding:10px 15px; width:65px;">Position</th>
                                        <th style="padding:10px 15px; width:100px;">Callsign</th>
                                        <th class="pilot-tail" style="padding:10px 15px; width:90px;">Tail #</th>
                                        <th class="pilot-squawk" style="padding:10px 15px; width:90px;">Squawk</th>
                                        <th class="pilot-transponder" style="padding:10px 15px; width:90px;">Transponder</th>
                                        <th class="pilot-nickname" style="padding:10px 15px;">Pilot</th>
                                        <th style="padding:10px 15px; width:40px;">{# Warning #}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% set lead_base = flight.departure_base %}
                                {% for pos in [1,2,3,4] %}
                                    {% set pilot = (flight.pilots|selectattr('position', 'equalto', pos|string)|list|first) %}
                                    {% set ac_location = pilot.aircraft_location if pilot and pilot.aircraft_location is defined else None %}
                                    <tr id="flight-pilot-row-{{ fid }}-{{ pos }}"{% if pos != 1 and pilot and ac_location and ac_location != lead_base %} class="table-warning"{% endif %}>
                                        <td style="padding:10px 15px; font-weight:500;">#{{ pos }}</td>
                                        <td style="padding:10px 15px;">{{ flight.callsign }}{{ '%02d' % pos }}</td>
                                        <td class="pilot-tail" style="padding:10px 15px;">{% if pilot and pilot.aircraft_id %}{{ pilot.aircraft_id }}{% else %}â€”{% endif %}</td>
                                        <td class="pilot-squawk" style="padding:10px 15px;">{% if pilot and pilot.squawk %}{{ pilot.squawk }}{% else %}â€”{% endif %}</td>
                                        <td class="pilot-transponder" style="padding:10px 15px;">{% if pilot and pilot.transponder %}{{ pilot.transponder }}{% else %}â€”{% endif %}</td>
                                        <td class="pilot-nickname" style="padding:10px 15px;">
                                            {% if pilot %}
                                                <span style="font-weight:500;">{{ pilot.nickname|format_nickname or pilot.name|format_nickname or pilot.pilot_name|format_nickname or 'FLIGHT LEAD' }}</span>
                                            {% else %}
                                                {% if pos == 1 %}
                                                    <span style="opacity:0.7;">FLIGHT LEAD</span>
                                                {% else %}
                                                    <span style="opacity:0.5;">OPEN SLOT</span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td style="padding:10px 15px; text-align:center;">
                                            {% if pos != 1 and pilot and ac_location and ac_location != lead_base %}
                                                <span title="Aircraft not at lead's base!" style="color:#ffc107; font-size:1.2em; cursor:help;">
                                                    &#9888;
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Join as position buttons -->
                        {% if flight.pilots|length < 4 and flight.status != 'LOCKED' %}
                            <div class="join-buttons mb-2">
                            {% set taken_positions = flight.pilots|map(attribute='position')|list %}
                            {% for pos in [2,3,4] %}
                                {% if pos|string not in taken_positions %}
                                    <button class="btn btn-sm btn-primary join-pos-btn" data-flight-id="{{ fid }}" data-squadron="{{ flight.squadron }}" data-base="{{ flight.departure_base }}" data-position="{{ pos }}">
                                        Join as {{ flight.callsign }}{{ '%02d' % pos }}
                                    </button>
                                    <div class="join-flight-form" id="join-form-{{ fid }}-{{ pos }}" style="display:none; margin-top:10px;">
                                        <form method="POST" action="{{ url_for('signup.join_existing_flight', mission_id=mission.id, flight_id=fid) }}">
                                            <input type="hidden" name="position" value="{{ pos }}">
                                            <div class="form-group">
                                                <label for="aircraft_id_{{ fid }}_{{ pos }}">Aircraft</label>
                                                <select class="form-control" name="aircraft_id" id="aircraft_id_{{ fid }}_{{ pos }}" required>
                                                    <option value="">Select aircraft</option>
                                                    <!-- Options will be populated by JS -->
                                                </select>
                                            </div>
                                            <div class="cross-base-warning text-warning" id="cross-base-warning-{{ fid }}-{{ pos }}" style="display:none; font-size:0.95em; margin-bottom:8px;">
                                                Warning: Selected aircraft is not at this flight's departure base!
                                            </div>
                                            <button type="submit" class="btn btn-success btn-sm">Join as {{ flight.callsign }}{{ '%02d' % pos }}</button>
                                            <button type="button" class="btn btn-secondary btn-sm cancel-join-btn" data-flight-id="{{ fid }}" data-position="{{ pos }}">Cancel</button>
                                        </form>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div>No flights created yet.</div>
            {% endif %}
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/signup_mission.js') }}"></script>
{% endblock %}
